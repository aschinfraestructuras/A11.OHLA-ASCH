<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Elimina√ß√£o - Portal de Calidad</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #2563eb; }
        .delete-button { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin: 2px; }
        .delete-button:hover { background: #dc2626; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .warning { background: #fef3c7; color: #92400e; }
        .log { background: #f3f4f6; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .file-item { display: flex; align-items: center; gap: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 5px 0; }
        .file-info { flex: 1; }
        .file-actions { display: flex; gap: 5px; }
        .file-action-btn { background: none; border: 1px solid #dee2e6; border-radius: 4px; padding: 5px 10px; cursor: pointer; margin: 0 2px; }
        .file-action-btn:hover { background: #3b82f6; color: white; }
        .delete-btn { background: #ef4444; color: white; border: 1px solid #ef4444; }
        .delete-btn:hover { background: #dc2626; }
    </style>
</head>
<body>
    <h1>üóëÔ∏è Teste de Elimina√ß√£o de Ficheiros</h1>
    
    <div class="test-section">
        <h2>1. Estado Atual dos Ficheiros</h2>
        <button class="test-button" onclick="checkCurrentFiles()">Verificar Ficheiros Atuais</button>
        <div id="current-files"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Criar Ficheiro de Teste</h2>
        <input type="file" id="testFile" accept=".html,.pdf,.docx,.xlsx,.doc,.xls,.txt,.rtf">
        <button class="test-button" onclick="createTestFile()">Criar Ficheiro de Teste</button>
        <div id="create-status"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Lista de Documentos para Eliminar</h2>
        <button class="test-button" onclick="loadDocuments()">Carregar Lista</button>
        <div id="documents-list"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Teste de Elimina√ß√£o</h2>
        <button class="test-button" onclick="testDeleteAll()">Eliminar Todos os Ficheiros</button>
        <button class="test-button" onclick="clearAllData()">Limpar Tudo (localStorage)</button>
        <div id="delete-status"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Verifica√ß√£o P√≥s-Elimina√ß√£o</h2>
        <button class="test-button" onclick="verifyDeletion()">Verificar se Foi Eliminado</button>
        <div id="verification-status"></div>
    </div>
    
    <div class="test-section">
        <h2>6. Logs do Sistema</h2>
        <button class="test-button" onclick="clearLogs()">Limpar Logs</button>
        <div id="logs" class="log"></div>
    </div>

    <script src="config.js"></script>
    <script src="assets/database.js"></script>
    <script src="assets/document-viewer.js"></script>
    <script src="assets/app.js"></script>
    
    <script>
        let portal;
        let testDocuments = [];
        
        // Interceptar console.log
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLog(message, type = 'log') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logEntry.style.color = type === 'error' ? '#991b1b' : type === 'warn' ? '#92400e' : '#1e40af';
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog(args.join(' '), 'warn');
        };
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function checkCurrentFiles() {
            try {
                showStatus('current-files', 'Verificando ficheiros...', 'info');
                
                // Verificar localStorage
                const storedDocs = JSON.parse(localStorage.getItem('storedDocuments') || '[]');
                const storedFiles = JSON.parse(localStorage.getItem('storedFiles') || '{}');
                
                console.log('üìä Documentos no localStorage:', storedDocs.length);
                console.log('üìÅ Ficheiros no localStorage:', Object.keys(storedFiles).length);
                
                let html = '<h3>Estado Atual:</h3>';
                html += `<p><strong>Documentos:</strong> ${storedDocs.length}</p>`;
                html += `<p><strong>Ficheiros:</strong> ${Object.keys(storedFiles).length}</p>`;
                
                if (storedDocs.length > 0) {
                    html += '<h4>Documentos Existentes:</h4>';
                    storedDocs.forEach(doc => {
                        html += `<div class="file-item">
                            <span>üìÑ</span>
                            <div class="file-info">
                                <div><strong>${doc.title || 'Sin t√≠tulo'}</strong></div>
                                <div>ID: ${doc.id} | Cap√≠tulo: ${doc.chapter || 'N/A'}</div>
                            </div>
                        </div>`;
                    });
                }
                
                document.getElementById('current-files').innerHTML = html;
                showStatus('current-files', '‚úÖ Verifica√ß√£o conclu√≠da', 'success');
                
            } catch (error) {
                showStatus('current-files', `‚ùå Erro: ${error.message}`, 'error');
                console.error('‚ùå Erro na verifica√ß√£o:', error);
            }
        }
        
        async function createTestFile() {
            try {
                const fileInput = document.getElementById('testFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showStatus('create-status', '‚ö†Ô∏è Selecione um ficheiro primeiro', 'warning');
                    return;
                }
                
                showStatus('create-status', 'Criando ficheiro de teste...', 'info');
                
                // Inicializar portal se necess√°rio
                if (!portal) {
                    portal = new PortalCalidad();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                // Simular dados do formul√°rio
                const testData = {
                    title: 'TESTE ELIMINA√á√ÉO - ' + new Date().toLocaleTimeString(),
                    chapter: '01_PAC',
                    tags: ['teste', 'elimina√ß√£o'],
                    status: 'Aprobado'
                };
                
                // Simular ficheiros selecionados
                portal.selectedFiles = [file];
                
                // Executar upload
                await portal.uploadDocuments();
                
                showStatus('create-status', '‚úÖ Ficheiro de teste criado!', 'success');
                console.log('‚úÖ Ficheiro de teste criado');
                
                // Recarregar lista
                await loadDocuments();
                
            } catch (error) {
                showStatus('create-status', `‚ùå Erro: ${error.message}`, 'error');
                console.error('‚ùå Erro ao criar ficheiro de teste:', error);
            }
        }
        
        async function loadDocuments() {
            try {
                const listDiv = document.getElementById('documents-list');
                listDiv.innerHTML = '<div class="status info">Carregando documentos...</div>';
                
                // Obter documentos do localStorage
                const storedDocs = JSON.parse(localStorage.getItem('storedDocuments') || '[]');
                testDocuments = storedDocs;
                
                if (storedDocs.length === 0) {
                    listDiv.innerHTML = '<div class="status info">Nenhum documento encontrado</div>';
                    return;
                }
                
                // Mostrar documentos com bot√µes de elimina√ß√£o
                listDiv.innerHTML = storedDocs.map(doc => `
                    <div class="file-item" data-doc-id="${doc.id}">
                        <span class="file-icon">üìÑ</span>
                        <div class="file-info">
                            <div class="file-name"><strong>${doc.title || 'Sin t√≠tulo'}</strong></div>
                            <div class="file-meta">ID: ${doc.id} | ${doc.chapter || 'Sin cap√≠tulo'} | ${doc.date || 'Sin fecha'}</div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn delete-btn" onclick="deleteSingleDocument('${doc.id}')" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
                
                console.log('‚úÖ Documentos carregados:', storedDocs.length);
                
            } catch (error) {
                document.getElementById('documents-list').innerHTML = `<div class="status error">Erro: ${error.message}</div>`;
                console.error('‚ùå Erro ao carregar documentos:', error);
            }
        }
        
        async function deleteSingleDocument(docId) {
            try {
                console.log('üóëÔ∏è Eliminando documento:', docId);
                
                if (confirm(`Tem certeza que quer eliminar este documento?\nID: ${docId}`)) {
                    // Inicializar portal se necess√°rio
                    if (!portal) {
                        portal = new PortalCalidad();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    await portal.deleteDocument(docId);
                    console.log('‚úÖ Documento eliminado:', docId);
                    
                    // Recarregar lista
                    await loadDocuments();
                    await checkCurrentFiles();
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao eliminar documento:', error);
            }
        }
        
        async function testDeleteAll() {
            try {
                showStatus('delete-status', 'Eliminando todos os ficheiros...', 'info');
                
                const storedDocs = JSON.parse(localStorage.getItem('storedDocuments') || '[]');
                
                if (storedDocs.length === 0) {
                    showStatus('delete-status', '‚ö†Ô∏è Nenhum documento para eliminar', 'warning');
                    return;
                }
                
                if (confirm(`Tem certeza que quer eliminar TODOS os ${storedDocs.length} documentos?`)) {
                    // Inicializar portal se necess√°rio
                    if (!portal) {
                        portal = new PortalCalidad();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    let deletedCount = 0;
                    
                    for (const doc of storedDocs) {
                        try {
                            await portal.deleteDocument(doc.id);
                            deletedCount++;
                            console.log(`‚úÖ Eliminado ${deletedCount}/${storedDocs.length}: ${doc.title}`);
                        } catch (error) {
                            console.error(`‚ùå Erro ao eliminar ${doc.title}:`, error);
                        }
                    }
                    
                    showStatus('delete-status', `‚úÖ ${deletedCount} documentos eliminados!`, 'success');
                    
                    // Recarregar lista
                    await loadDocuments();
                    await checkCurrentFiles();
                }
                
            } catch (error) {
                showStatus('delete-status', `‚ùå Erro: ${error.message}`, 'error');
                console.error('‚ùå Erro na elimina√ß√£o em massa:', error);
            }
        }
        
        async function clearAllData() {
            try {
                if (confirm('Tem certeza que quer limpar TODOS os dados do localStorage?\n\nIsso ir√° eliminar:\n- Todos os documentos\n- Todos os ficheiros\n- Todos os dados armazenados')) {
                    showStatus('delete-status', 'Limpando todos os dados...', 'info');
                    
                    // Limpar localStorage
                    localStorage.removeItem('storedDocuments');
                    localStorage.removeItem('storedFiles');
                    localStorage.removeItem('uploadedDocuments');
                    
                    // Limpar IndexedDB se poss√≠vel
                    try {
                        if (typeof dbManager !== 'undefined') {
                            // Tentar limpar IndexedDB
                            console.log('üßπ Limpando IndexedDB...');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel limpar IndexedDB:', error);
                    }
                    
                    showStatus('delete-status', '‚úÖ Todos os dados foram limpos!', 'success');
                    console.log('‚úÖ localStorage limpo completamente');
                    
                    // Recarregar lista
                    await loadDocuments();
                    await checkCurrentFiles();
                }
                
            } catch (error) {
                showStatus('delete-status', `‚ùå Erro: ${error.message}`, 'error');
                console.error('‚ùå Erro ao limpar dados:', error);
            }
        }
        
        async function verifyDeletion() {
            try {
                showStatus('verification-status', 'Verificando elimina√ß√£o...', 'info');
                
                // Verificar localStorage
                const storedDocs = JSON.parse(localStorage.getItem('storedDocuments') || '[]');
                const storedFiles = JSON.parse(localStorage.getItem('storedFiles') || '{}');
                
                let html = '<h3>Verifica√ß√£o P√≥s-Elimina√ß√£o:</h3>';
                html += `<p><strong>Documentos restantes:</strong> ${storedDocs.length}</p>`;
                html += `<p><strong>Ficheiros restantes:</strong> ${Object.keys(storedFiles).length}</p>`;
                
                if (storedDocs.length === 0 && Object.keys(storedFiles).length === 0) {
                    html += '<div class="status success">‚úÖ Todos os dados foram eliminados com sucesso!</div>';
                    showStatus('verification-status', '‚úÖ Elimina√ß√£o verificada - dados limpos', 'success');
                } else {
                    html += '<div class="status warning">‚ö†Ô∏è Ainda existem dados no sistema</div>';
                    showStatus('verification-status', '‚ö†Ô∏è Ainda existem dados no sistema', 'warning');
                }
                
                document.getElementById('verification-status').innerHTML = html;
                
            } catch (error) {
                showStatus('verification-status', `‚ùå Erro: ${error.message}`, 'error');
                console.error('‚ùå Erro na verifica√ß√£o:', error);
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Inicializar automaticamente
        window.addEventListener('load', () => {
            console.log('üöÄ Sistema de teste de elimina√ß√£o carregado');
            console.log('üìã Instru√ß√µes:');
            console.log('1. Clique em "Verificar Ficheiros Atuais" para ver o estado');
            console.log('2. Crie um ficheiro de teste se necess√°rio');
            console.log('3. Use os bot√µes de elimina√ß√£o para testar');
            console.log('4. Verifique se a elimina√ß√£o foi permanente');
        });
    </script>
</body>
</html>
